#!/bin/sh

# Exit on error
#set -e

if [ $(grep -r "port = 80" /etc/lighttpd/ | wc -l) -eq 0 ]
then
        #(old bmk-webstatus version check) - check if we have the last original lighttpd.conf saved...
        if [ -f "/etc/lighttpd/lighttpd.old" ]; then
                cp /etc/lighttpd/lighttpd.old /etc/lighttpd/lighttpd.conf
                # remove old file...
                rm /etc/lighttpd/lighttpd.old
        fi
        if [ -f "/etc/lighttpd/conf-enabled/10-ssl.old" ]; then
                cp /etc/lighttpd/conf-enabled/10-ssl.old /etc/lighttpd/conf-enabled/10-ssl.conf
                # remove old file...
                rm /etc/lighttpd/conf-enabled/10-ssl.old
        fi
fi

# stop custom Webserver if running
if [ -f "/var/run/lighttpd_custom.pid" ]; then
        sudo /sbin/start-stop-daemon --stop --pidfile /var/run/lighttpd_custom.pid
        if [ -f "/var/run/lighttpd_custom.pid" ]; then
                rm /var/run/lighttpd_custom.pid
        fi
fi

# stop EdgeOS original Webserver if running
if [ -f "/var/run/lighttpd_custom.pid" ]; then
        sudo /sbin/start-stop-daemon --stop --pidfile /var/run/lighttpd.pid
        if [ -f "/var/run/lighttpd.pid" ]; then
                rm /var/run/lighttpd.pid
        fi
fi

if [ $(grep -r "port = 80" /etc/lighttpd/ | wc -l) -eq 0 ]
then
        if [ -f "/var/www/htdocs/cgi-bin-status.php" ]; then
                rm /var/www/htdocs/cgi-bin-status.php
        fi

        if [ -f "/var/www/htdocs/namevlans.php" ]; then
                rm /var/www/htdocs/namevlans.php
        fi
fi

# remove old custom folder with content!! (WARNING)
if [ -d "/config/custom/" ]
then
        rm -R /config/custom/
fi

exit 0
